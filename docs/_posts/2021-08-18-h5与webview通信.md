---
layout: post
title:  "h5与webView通信"
date:   2021-08-18
categories: h5
tags: h5 webview app
---

* content
{:toc}
### 1.为什么有这个需求：

app跳转到h5需要携带一些用户信息

### 2.两个重要文件：

main.js和public目录下的index.html

### 3.交互核心：

使用WebViewJavaScriptBridge对象

### 4.逻辑：

   1 ) . 判断如果是移动端（navigator.userAgent.indexOf('car-finance-crm') < 0）， 调用connectWebViewJavascriptBridge方法，（可以在这个方法里面进行注册或调用一些方法）

   2 ) . 调用connectWebViewJavascriptBridge方法，方法里首先根据navigator.userAgent判断一下当前环境，执行对应的操作。

ios需要判断是否存在window.WebViewJavascriptBridge变量，如果不存在继续判断window.WVJBCallbacks变量，如果仍然不存在，则手动赋值为H5回调，然后document.createElement('iframe')插入document中，随即移除。

安卓端安卓需要进行兼容性判断，如果不存在window.WebViewJavascriptBridge变量，需要手动添加Dom的WebViewJavascriptBridgeReady事件监听

```
 function connectWebViewJavascriptBridge(callback) {
 //根据设备类型判断设备是android还是ios，执行相应的操作
		 //ios使用WebViewJavaScriptBridge方法
        if (navigator.userAgent.indexOf("car-finance-crm-ios") >= 0) {
          if (window.WebViewJavascriptBridge) {
            return callback(WebViewJavascriptBridge);
          } 
          if (window.WVJBCallbacks) {
            return window.WVJBCallbacks.push(callback);
          }
          window.WVJBCallbacks = [callback];
          const WVJBIframe = document.createElement("iframe");
          WVJBIframe.style.display = "none";
          WVJBIframe.src = "https://__bridge_loaded__";
          document.documentElement.appendChild(WVJBIframe);
          setTimeout(function() {
            document.documentElement.removeChild(WVJBIframe);
          }, 0);
        } 
        //android使用WebViewJavaScriptBridge方法
        else if (
          navigator.userAgent.indexOf("car-finance-crm-android") >= 0
        ) {
          if (window.WebViewJavascriptBridge) {
            callback(WebViewJavascriptBridge);
          } else {
            document.addEventListener(
              "WebViewJavascriptBridgeReady",
              function() {
                callback(WebViewJavascriptBridge);
              },
              false
            );
          }
        }
      }

```



   3 ) .以上处理完成后，在调用connectWebViewJavascriptBridge方法时通过WebViewJavascriptBridge变量来注册【事件】以便APP能监听到并执行相应操作

```
 bridge.registerHandler('xxx方法名', function(data, responseCallback) {
	//客户端进行调用（方法名也是xxx），responseCallback是回调函数
	
	
	//逻辑代码
	//
	responseCallback()

	// 这边注册的方法是getUserInfo,需要在逻辑代码中加入设置headers的代码
	  const json = JSON.parse(data)
	  axios.defaults.headers.common['X-xk-token'] = json['X-xk-token']
       axios.defaults.headers.common['X-di'] = json['xdi']

   }
```

4 ). js端调用APP端方法

```
connectWebViewJavascriptBridge(function(bridge) {
          bridge.callHandler('transform', {
            'path': 'gps',
            'appCode': 'SN20180416133446000141'
          }, function() {
            lock = false
          })
        })
```